<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Home Cameras (WebRTC)</title>
    <style>
        html {
            height: 100%;
        }

        body {
            background: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            font-family: sans-serif;
            height: 100%;
            box-sizing: border-box;
        }


        #layout-container {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr 1fr 1fr;
            grid-auto-rows: 1fr 1fr 1fr;
            grid-template-areas:
                "cam1 cam1 cam2"
                "cam1 cam1 cam3"
                "cam4 cam5 cam6";
            height: 100%;
            width: 100%;
        }
        video {
            width: 100%;
            height: 100%;
            background: #111;
            border-radius: 8px;
        }
        .cam {
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        .status {
            color: #fff;
            font-size: 0.9rem;
            position: absolute;
            top: 5px;
            left: 5px;
            text-shadow: 2px 2px 5px black;
        }
        .fullscreenbtn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="layout-container"></div>
<script>
  async function connectWebRTC(videoEl, path, statusEl, attempt = 1) {
    try {

      const pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        videoEl.srcObject = event.streams[0];
        statusEl.textContent = "";
      };

      pc.addTransceiver("video", { direction: "recvonly" });
      pc.addTransceiver("audio", { direction: "recvonly" });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const res = await fetch(`http://${location.hostname}:8189/${path}/whep`, {
        method: "POST",
        body: offer.sdp,
        headers: { "Content-Type": "application/sdp" },
      });

      const answer = await res.text();
      await pc.setRemoteDescription({ type: "answer", sdp: answer });

      // Reconnect logic
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
          statusEl.textContent = "🔄 reconnecting...";
          setTimeout(() => connectWebRTC(videoEl, path, statusEl, attempt + 1), 5000);
        } else if (pc.connectionState === "connected") {
          statusEl.textContent = "✅";
        }
      };

    } catch (err) {
      if (attempt < 20) {
        console.error(`[${path}] WebRTC error:`, err);
        statusEl.textContent = "🔄 reconnecting...";
        setTimeout(() => connectWebRTC(videoEl, path, statusEl, attempt + 1), 5000);
      } else {
        statusEl.textContent = "❌ Failed to connect";
      }

    }
  }

  async function init() {

    // Cams. path value must correspond to paths set in mediamtx.yml.
    // The path value is also used for the css grid area.
    const cameras = [
      {
        "path": "cam1"
      },
      {
        "path": "cam2"
      },
      {
        "path": "cam3"
      },
      {
        "path": "cam4"
      },
      {
        "path": "cam5"
      }
    ];

    const layout_container = document.getElementById('layout-container');

    for (const cam of cameras) {
      const container = document.createElement("div");
      container.className = "cam";
      container.style.gridArea = cam.path;

      const video = document.createElement("video");
      video.autoplay = true;
      video.playsInline = true;
      video.muted = true;
      video.controls = false;

      const status = document.createElement("div");
      status.className = "status";
      status.textContent = "Connecting...";

      const fullscreenbtn = document.createElement('button');
      fullscreenbtn.className = 'fullscreenbtn';
      fullscreenbtn.textContent = '⛶';

      fullscreenbtn.addEventListener('click', (e) => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          container.requestFullscreen();
        }
      })

      container.appendChild(video);
      container.appendChild(status);
      container.appendChild(fullscreenbtn);
      layout_container.appendChild(container);

      await connectWebRTC(video, cam.path, status);
    }
  }

  init();
</script>
</body>
</html>
